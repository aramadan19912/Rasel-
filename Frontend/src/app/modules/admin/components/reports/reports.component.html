<div class="reports-container">
  <div class="reports-header">
    <h1>{{ 'admin.reports.title' | translate }}</h1>
    <div class="header-actions">
      <button mat-raised-button color="primary" (click)="refreshReport()">
        <mat-icon>refresh</mat-icon>
        {{ 'common.refresh' | translate }}
      </button>
      <button mat-raised-button color="accent" [matMenuTriggerFor]="exportMenu" *ngIf="selectedReportType === 'correspondence'">
        <mat-icon>download</mat-icon>
        {{ 'admin.reports.export' | translate }}
      </button>
      <mat-menu #exportMenu="matMenu">
        <button mat-menu-item (click)="exportReport('CSV')">
          <mat-icon>description</mat-icon>
          {{ 'admin.reports.exportCSV' | translate }}
        </button>
        <button mat-menu-item (click)="exportReport('Excel')">
          <mat-icon>table_chart</mat-icon>
          {{ 'admin.reports.exportExcel' | translate }}
        </button>
        <button mat-menu-item (click)="exportReport('PDF')">
          <mat-icon>picture_as_pdf</mat-icon>
          {{ 'admin.reports.exportPDF' | translate }}
        </button>
      </mat-menu>
    </div>
  </div>

  <!-- Report Type Selection -->
  <mat-tab-group [(selectedIndex)]="selectedReportType" (selectedIndexChange)="onReportTypeChange($event)">
    <mat-tab label="{{ 'admin.reports.correspondenceReport' | translate }}">
      <!-- Correspondence Report -->
      <div *ngIf="!loading && correspondenceReport" class="report-content">
        <!-- Filters -->
        <mat-card class="filters-card">
          <mat-card-header>
            <mat-card-title>{{ 'admin.reports.filters' | translate }}</mat-card-title>
          </mat-card-header>
          <mat-card-content>
            <div class="filters-row">
              <mat-form-field appearance="outline">
                <mat-label>{{ 'admin.dashboard.startDate' | translate }}</mat-label>
                <input matInput [matDatepicker]="startPicker" [(ngModel)]="correspondenceFilter.startDate" (dateChange)="onDateRangeChange()">
                <mat-datepicker-toggle matIconSuffix [for]="startPicker"></mat-datepicker-toggle>
                <mat-datepicker #startPicker></mat-datepicker>
              </mat-form-field>

              <mat-form-field appearance="outline">
                <mat-label>{{ 'admin.dashboard.endDate' | translate }}</mat-label>
                <input matInput [matDatepicker]="endPicker" [(ngModel)]="correspondenceFilter.endDate" (dateChange)="onDateRangeChange()">
                <mat-datepicker-toggle matIconSuffix [for]="endPicker"></mat-datepicker-toggle>
                <mat-datepicker #endPicker></mat-datepicker>
              </mat-form-field>
            </div>
          </mat-card-content>
        </mat-card>

        <!-- Summary Statistics -->
        <mat-card class="summary-card">
          <mat-card-header>
            <mat-card-title>{{ 'admin.reports.summary' | translate }}</mat-card-title>
          </mat-card-header>
          <mat-card-content>
            <div class="stats-grid">
              <div class="stat-item">
                <h3>{{ correspondenceReport.totalCount }}</h3>
                <p>{{ 'admin.reports.totalCorrespondences' | translate }}</p>
              </div>
              <div class="stat-item">
                <h3>{{ correspondenceReport.overdueCount }}</h3>
                <p>{{ 'admin.reports.overdueCount' | translate }}</p>
              </div>
              <div class="stat-item">
                <h3>{{ correspondenceReport.averageCompletionTime | number: '1.1-1' }}</h3>
                <p>{{ 'admin.reports.avgCompletionHours' | translate }}</p>
              </div>
            </div>
          </mat-card-content>
        </mat-card>

        <!-- Charts Row -->
        <div class="charts-row">
          <!-- Status Breakdown Chart -->
          <mat-card class="chart-card">
            <mat-card-header>
              <mat-card-title>{{ 'admin.reports.statusBreakdown' | translate }}</mat-card-title>
            </mat-card-header>
            <mat-card-content>
              <ngx-charts-pie-chart
                [view]="view"
                [results]="statusChartData"
                [gradient]="gradient"
                [legend]="showLegend"
                [labels]="true"
                [doughnut]="true"
                [scheme]="colorScheme">
              </ngx-charts-pie-chart>
            </mat-card-content>
          </mat-card>

          <!-- Priority Breakdown Chart -->
          <mat-card class="chart-card">
            <mat-card-header>
              <mat-card-title>{{ 'admin.reports.priorityBreakdown' | translate }}</mat-card-title>
            </mat-card-header>
            <mat-card-content>
              <ngx-charts-bar-vertical
                [view]="view"
                [results]="priorityChartData"
                [gradient]="gradient"
                [xAxis]="showXAxis"
                [yAxis]="showYAxis"
                [legend]="showLegend"
                [showXAxisLabel]="showXAxisLabel"
                [showYAxisLabel]="showYAxisLabel"
                [xAxisLabel]="xAxisLabel"
                [yAxisLabel]="yAxisLabel"
                [scheme]="colorScheme">
              </ngx-charts-bar-vertical>
            </mat-card-content>
          </mat-card>
        </div>

        <!-- Department Breakdown Chart -->
        <mat-card class="chart-card full-width" *ngIf="departmentChartData.length > 0">
          <mat-card-header>
            <mat-card-title>{{ 'admin.reports.departmentBreakdown' | translate }}</mat-card-title>
          </mat-card-header>
          <mat-card-content>
            <ngx-charts-bar-horizontal
              [view]="[1200, 400]"
              [results]="departmentChartData"
              [gradient]="gradient"
              [xAxis]="showXAxis"
              [yAxis]="showYAxis"
              [legend]="showLegend"
              [showXAxisLabel]="showXAxisLabel"
              [showYAxisLabel]="showYAxisLabel"
              [xAxisLabel]="xAxisLabel"
              [yAxisLabel]="yAxisLabel"
              [scheme]="colorScheme">
            </ngx-charts-bar-horizontal>
          </mat-card-content>
        </mat-card>

        <!-- Top Correspondences Table -->
        <mat-card class="table-card">
          <mat-card-header>
            <mat-card-title>{{ 'admin.reports.topCorrespondences' | translate }}</mat-card-title>
          </mat-card-header>
          <mat-card-content>
            <table mat-table [dataSource]="correspondenceReport.topCorrespondences" class="full-width">
              <ng-container matColumnDef="referenceNumber">
                <th mat-header-cell *matHeaderCellDef>{{ 'admin.reports.referenceNumber' | translate }}</th>
                <td mat-cell *matCellDef="let element">{{ element.referenceNumber }}</td>
              </ng-container>

              <ng-container matColumnDef="subject">
                <th mat-header-cell *matHeaderCellDef>{{ 'admin.reports.subject' | translate }}</th>
                <td mat-cell *matCellDef="let element">{{ element.subject }}</td>
              </ng-container>

              <ng-container matColumnDef="status">
                <th mat-header-cell *matHeaderCellDef>{{ 'admin.reports.status' | translate }}</th>
                <td mat-cell *matCellDef="let element">
                  <span class="status-badge" [class]="element.status">{{ element.status }}</span>
                </td>
              </ng-container>

              <ng-container matColumnDef="priority">
                <th mat-header-cell *matHeaderCellDef>{{ 'admin.reports.priority' | translate }}</th>
                <td mat-cell *matCellDef="let element">
                  <span class="priority-badge" [class]="element.priority">{{ element.priority }}</span>
                </td>
              </ng-container>

              <ng-container matColumnDef="createdAt">
                <th mat-header-cell *matHeaderCellDef>{{ 'admin.reports.createdAt' | translate }}</th>
                <td mat-cell *matCellDef="let element">{{ element.createdAt | date: 'short' }}</td>
              </ng-container>

              <tr mat-header-row *matHeaderRowDef="['referenceNumber', 'subject', 'status', 'priority', 'createdAt']"></tr>
              <tr mat-row *matRowDef="let row; columns: ['referenceNumber', 'subject', 'status', 'priority', 'createdAt'];"></tr>
            </table>
          </mat-card-content>
        </mat-card>
      </div>
    </mat-tab>

    <mat-tab label="{{ 'admin.reports.employeePerformance' | translate }}">
      <!-- Employee Performance Report -->
      <div *ngIf="!loading && employeePerformanceReports.length > 0" class="report-content">
        <mat-card *ngFor="let report of employeePerformanceReports" class="performance-card">
          <mat-card-header>
            <mat-card-title>{{ report.employeeName }}</mat-card-title>
            <mat-card-subtitle>{{ report.departmentName }}</mat-card-subtitle>
          </mat-card-header>
          <mat-card-content>
            <div class="performance-stats">
              <div class="stat-item">
                <h4>{{ report.totalAssigned }}</h4>
                <p>{{ 'admin.reports.totalAssigned' | translate }}</p>
              </div>
              <div class="stat-item">
                <h4>{{ report.completed }}</h4>
                <p>{{ 'admin.reports.completed' | translate }}</p>
              </div>
              <div class="stat-item">
                <h4>{{ report.pending }}</h4>
                <p>{{ 'admin.reports.pending' | translate }}</p>
              </div>
              <div class="stat-item">
                <h4>{{ report.overdue }}</h4>
                <p>{{ 'admin.reports.overdue' | translate }}</p>
              </div>
              <div class="stat-item">
                <h4>{{ report.completionRate | number: '1.1-1' }}%</h4>
                <p>{{ 'admin.reports.completionRate' | translate }}</p>
              </div>
              <div class="stat-item">
                <h4>{{ report.averageCompletionTime | number: '1.1-1' }}</h4>
                <p>{{ 'admin.reports.avgCompletionHours' | translate }}</p>
              </div>
            </div>
          </mat-card-content>
        </mat-card>
      </div>
    </mat-tab>

    <mat-tab label="{{ 'admin.reports.departmentReport' | translate }}">
      <!-- Department Reports -->
      <div *ngIf="!loading && departmentReports.length > 0" class="report-content">
        <mat-card *ngFor="let report of departmentReports" class="department-report-card">
          <mat-card-header>
            <mat-card-title>{{ report.departmentName }}</mat-card-title>
            <mat-card-subtitle *ngIf="report.managerName">{{ 'admin.dashboard.manager' | translate }}: {{ report.managerName }}</mat-card-subtitle>
          </mat-card-header>
          <mat-card-content>
            <div class="department-stats">
              <div class="stat-item">
                <h4>{{ report.totalEmployees }}</h4>
                <p>{{ 'admin.reports.totalEmployees' | translate }}</p>
              </div>
              <div class="stat-item">
                <h4>{{ report.totalCorrespondences }}</h4>
                <p>{{ 'admin.reports.totalCorrespondences' | translate }}</p>
              </div>
              <div class="stat-item">
                <h4>{{ report.completedCorrespondences }}</h4>
                <p>{{ 'admin.reports.completed' | translate }}</p>
              </div>
              <div class="stat-item">
                <h4>{{ report.completionRate | number: '1.1-1' }}%</h4>
                <p>{{ 'admin.reports.completionRate' | translate }}</p>
              </div>
              <div class="stat-item">
                <h4>{{ report.averageResponseTime | number: '1.1-1' }}</h4>
                <p>{{ 'admin.reports.avgResponseTime' | translate }}</p>
              </div>
            </div>
          </mat-card-content>
        </mat-card>
      </div>
    </mat-tab>
  </mat-tab-group>

  <!-- Loading State -->
  <div *ngIf="loading" class="loading-container">
    <mat-spinner></mat-spinner>
    <p>{{ 'common.loading' | translate }}</p>
  </div>
</div>
