<div class="archive-management-container">
  <div class="archive-header">
    <h1>{{ 'archive.title' | translate }}</h1>
    <div class="header-actions">
      <button mat-raised-button color="primary" (click)="addCategory()">
        <mat-icon>add</mat-icon>
        {{ 'archive.addCategory' | translate }}
      </button>
      <button mat-icon-button (click)="refreshData()" [matTooltip]="'common.refresh' | translate">
        <mat-icon>refresh</mat-icon>
      </button>
    </div>
  </div>

  <!-- View Toggle -->
  <mat-button-toggle-group [(value)]="activeView" class="view-toggle">
    <mat-button-toggle value="tree">
      <mat-icon>account_tree</mat-icon>
      {{ 'archive.views.tree' | translate }}
    </mat-button-toggle>
    <mat-button-toggle value="list">
      <mat-icon>view_list</mat-icon>
      {{ 'archive.views.list' | translate }}
    </mat-button-toggle>
    <mat-button-toggle value="stats">
      <mat-icon>bar_chart</mat-icon>
      {{ 'archive.views.statistics' | translate }}
    </mat-button-toggle>
  </mat-button-toggle-group>

  <!-- Tree View -->
  <div class="content-area" *ngIf="activeView === 'tree' && !loading">
    <mat-card class="tree-view-card">
      <mat-card-content>
        <div class="tree-container">
          <ng-container *ngTemplateOutlet="treeNodeTemplate; context: { nodes: categoryHierarchy }"></ng-container>
        </div>

        <div *ngIf="categoryHierarchy.length === 0" class="empty-state">
          <mat-icon>folder_open</mat-icon>
          <p>{{ 'archive.noCategories' | translate }}</p>
        </div>
      </mat-card-content>
    </mat-card>
  </div>

  <!-- List View -->
  <div class="content-area" *ngIf="activeView === 'list' && !loading">
    <mat-card class="list-view-card">
      <mat-card-content>
        <table mat-table [dataSource]="categories" class="categories-table">
          <!-- Category Code Column -->
          <ng-container matColumnDef="categoryCode">
            <th mat-header-cell *matHeaderCellDef>{{ 'archive.categoryCode' | translate }}</th>
            <td mat-cell *matCellDef="let category">{{ category.categoryCode }}</td>
          </ng-container>

          <!-- Name Column -->
          <ng-container matColumnDef="name">
            <th mat-header-cell *matHeaderCellDef>{{ 'archive.name' | translate }}</th>
            <td mat-cell *matCellDef="let category">{{ getCategoryName(category) }}</td>
          </ng-container>

          <!-- Classification Column -->
          <ng-container matColumnDef="classification">
            <th mat-header-cell *matHeaderCellDef>{{ 'archive.classification' | translate }}</th>
            <td mat-cell *matCellDef="let category">
              <mat-chip [style.background-color]="getClassificationColor(category.classification)">
                {{ 'correspondence.classifications.' + category.classification | translate }}
              </mat-chip>
            </td>
          </ng-container>

          <!-- Retention Period Column -->
          <ng-container matColumnDef="retentionPeriod">
            <th mat-header-cell *matHeaderCellDef>{{ 'archive.retentionPeriod' | translate }}</th>
            <td mat-cell *matCellDef="let category">{{ 'archive.retentionPeriods.' + category.retentionPeriod | translate }}</td>
          </ng-container>

          <!-- Active Status Column -->
          <ng-container matColumnDef="isActive">
            <th mat-header-cell *matHeaderCellDef>{{ 'archive.status' | translate }}</th>
            <td mat-cell *matCellDef="let category">
              <mat-chip [class.active]="category.isActive" [class.inactive]="!category.isActive">
                {{ category.isActive ? ('common.active' | translate) : ('common.inactive' | translate) }}
              </mat-chip>
            </td>
          </ng-container>

          <!-- Actions Column -->
          <ng-container matColumnDef="actions">
            <th mat-header-cell *matHeaderCellDef>{{ 'common.actions' | translate }}</th>
            <td mat-cell *matCellDef="let category">
              <button mat-icon-button (click)="editCategory(category)" [matTooltip]="'common.edit' | translate">
                <mat-icon>edit</mat-icon>
              </button>
              <button mat-icon-button (click)="deleteCategory(category)" [matTooltip]="'common.delete' | translate">
                <mat-icon color="warn">delete</mat-icon>
              </button>
            </td>
          </ng-container>

          <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
          <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
        </table>

        <div *ngIf="categories.length === 0" class="empty-state">
          <mat-icon>folder_open</mat-icon>
          <p>{{ 'archive.noCategories' | translate }}</p>
        </div>
      </mat-card-content>
    </mat-card>
  </div>

  <!-- Statistics View -->
  <div class="content-area" *ngIf="activeView === 'stats' && !loading">
    <div class="stats-grid">
      <mat-card *ngFor="let stat of categoryStats" class="stat-card">
        <mat-card-header>
          <mat-card-title>{{ stat.categoryName }}</mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <div class="stat-item">
            <div class="stat-icon">
              <mat-icon>description</mat-icon>
            </div>
            <div class="stat-info">
              <span class="stat-label">{{ 'archive.stats.totalCorrespondences' | translate }}</span>
              <span class="stat-value">{{ stat.totalCorrespondences }}</span>
            </div>
          </div>

          <div class="stat-item">
            <div class="stat-icon">
              <mat-icon>archive</mat-icon>
            </div>
            <div class="stat-info">
              <span class="stat-label">{{ 'archive.stats.archived' | translate }}</span>
              <span class="stat-value">{{ stat.archivedCorrespondences }}</span>
            </div>
          </div>

          <div class="stat-item">
            <div class="stat-icon">
              <mat-icon>pending</mat-icon>
            </div>
            <div class="stat-info">
              <span class="stat-label">{{ 'archive.stats.pending' | translate }}</span>
              <span class="stat-value">{{ stat.pendingCorrespondences }}</span>
            </div>
          </div>

          <div class="stat-item">
            <div class="stat-icon">
              <mat-icon>check_circle</mat-icon>
            </div>
            <div class="stat-info">
              <span class="stat-label">{{ 'archive.stats.completed' | translate }}</span>
              <span class="stat-value">{{ stat.completedCorrespondences }}</span>
            </div>
          </div>

          <div class="stat-item">
            <div class="stat-icon">
              <mat-icon>storage</mat-icon>
            </div>
            <div class="stat-info">
              <span class="stat-label">{{ 'archive.stats.totalSize' | translate }}</span>
              <span class="stat-value">{{ formatFileSize(stat.totalSize) }}</span>
            </div>
          </div>

          <div class="stat-item" *ngIf="stat.lastCorrespondenceDate">
            <div class="stat-icon">
              <mat-icon>schedule</mat-icon>
            </div>
            <div class="stat-info">
              <span class="stat-label">{{ 'archive.stats.lastCorrespondence' | translate }}</span>
              <span class="stat-value">{{ stat.lastCorrespondenceDate | date: 'short' }}</span>
            </div>
          </div>
        </mat-card-content>
      </mat-card>
    </div>

    <div *ngIf="categoryStats.length === 0" class="empty-state">
      <mat-icon>bar_chart</mat-icon>
      <p>{{ 'archive.noStatistics' | translate }}</p>
    </div>
  </div>

  <!-- Loading State -->
  <div class="loading-container" *ngIf="loading">
    <mat-spinner></mat-spinner>
    <p>{{ 'common.loading' | translate }}</p>
  </div>
</div>

<!-- Tree Node Template -->
<ng-template #treeNodeTemplate let-nodes="nodes">
  <div class="tree-nodes">
    <div *ngFor="let node of nodes" class="tree-node" [style.padding-left.px]="node.level * 24">
      <div class="node-content">
        <button mat-icon-button *ngIf="node.children.length > 0" (click)="toggleNode(node)" class="expand-button">
          <mat-icon>{{ node.expanded ? 'expand_more' : 'chevron_right' }}</mat-icon>
        </button>
        <div class="node-info">
          <mat-icon *ngIf="node.icon" [style.color]="node.color">{{ node.icon }}</mat-icon>
          <mat-icon *ngIf="!node.icon">folder</mat-icon>
          <span class="node-name">{{ node.name }}</span>
          <mat-chip [style.background-color]="getClassificationColor(node.classification)" class="classification-chip">
            {{ 'correspondence.classifications.' + node.classification | translate }}
          </mat-chip>
        </div>
      </div>
      <div *ngIf="node.expanded && node.children.length > 0" class="node-children">
        <ng-container *ngTemplateOutlet="treeNodeTemplate; context: { nodes: node.children }"></ng-container>
      </div>
    </div>
  </div>
</ng-template>
